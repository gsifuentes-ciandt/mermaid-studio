<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Studio Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .toolbar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .toolbar-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-success {
            background: #059669;
            color: white;
        }
        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        .btn-secondary:hover {
            background: #475569;
        }
        
        .search-filter-bar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-label {
            font-weight: 600;
            color: #555;
        }
        select {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .diagram-count {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        
        .content {
            padding: 30px;
            min-height: 400px;
        }
        
        .diagrams-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 24px;
        }
        
        .diagram-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 380px;
        }
        .diagram-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #6366f1;
        }
        .diagram-card-header {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            flex-shrink: 0;
        }
        .diagram-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .type-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        .type-workflow {
            background: #dbeafe;
            color: #1e40af;
        }
        .type-endpoint {
            background: #dcfce7;
            color: #166534;
        }
        .type-architecture {
            background: #fef3c7;
            color: #92400e;
        }
        .type-sequence {
            background: #fce7f3;
            color: #9f1239;
        }
        .type-state {
            background: #e0e7ff;
            color: #3730a3;
        }
        .type-other {
            background: #e5e7eb;
            color: #374151;
        }
        .diagram-card-meta {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .diagram-card-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .diagram-card-actions button {
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .diagram-card-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-edit {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        .btn-edit:hover {
            background: #fef3c7;
            border-color: #d97706;
        }
        .btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }
        .btn-delete:hover {
            background: #fee2e2;
            border-color: #dc2626;
        }
        .btn-info {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .btn-info:hover {
            background: #dbeafe;
            border-color: #2563eb;
        }
        .btn-export {
            border-color: #10b981;
            color: #10b981;
        }
        .btn-export:hover {
            background: #d1fae5;
            border-color: #059669;
        }
        .export-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 6px;
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .export-dropdown.active {
            display: flex;
        }
        .export-dropdown button {
            background: white;
            color: #374151;
            border: none;
            border-radius: 0;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: none;
        }
        .export-dropdown button:hover {
            background: #f3f4f6;
            transform: none;
            box-shadow: none;
        }
        .export-dropdown button:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
        .diagram-preview {
            padding: 16px;
            background: white;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: background 0.2s;
        }
        .diagram-preview:hover {
            background: #f9fafb;
        }
        .diagram-preview svg {
            max-width: 100%;
            max-height: 100%;
            height: auto;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 20px;
        }
        .modal-header {
            padding: 24px 30px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-header h2 {
            font-size: 24px;
        }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }
        .modal-body {
            padding: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        .form-group label .required {
            color: #ef4444;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            font-family: 'Courier New', monospace;
            min-height: 200px;
            resize: vertical;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
        }
        
        .payload-section {
            margin-top: 15px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }
        .payload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .payload-label {
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }
        .add-payload-btn {
            padding: 4px 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .payload-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        .payload-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-payload-btn {
            padding: 4px 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        .payload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .info-card {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-card-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .info-card-content {
            color: #1e40af;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Zoom Modal Styles */
        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            overflow: hidden;
        }
        .zoom-modal.active {
            display: block;
        }
        .zoom-modal.light-mode {
            background: rgba(255, 255, 255, 0.98);
        }
        .zoom-modal.fullscreen-clean .zoom-info-panel,
        .zoom-modal.fullscreen-clean .zoom-controls,
        .zoom-modal.fullscreen-clean .minimap,
        .zoom-modal.fullscreen-clean .keyboard-help {
            display: none;
        }
        .zoom-close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            color: #333;
            font-size: 24px;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2003;
        }
        .zoom-modal.light-mode .zoom-close-btn {
            background: white;
            border: 2px solid #e5e7eb;
        }
        .zoom-close-btn:hover {
            background: #f3f4f6;
            transform: rotate(90deg);
        }
        .zoom-info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 2002;
            max-width: 400px;
        }
        .zoom-modal.light-mode .zoom-info-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #e5e7eb;
        }
        .zoom-info-title {
            font-weight: 700;
            font-size: 16px;
            color: #6366f1;
            margin-bottom: 8px;
        }
        .zoom-info-meta {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
        }
        .zoom-controls {
            position: fixed;
            top: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2002;
        }
        .zoom-controls-row {
            display: flex;
            gap: 10px;
        }
        .zoom-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            color: #333;
            font-size: 18px;
            min-width: 48px;
            height: 48px;
            padding: 0 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .zoom-modal.light-mode .zoom-btn {
            background: white;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .zoom-btn:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }
        .zoom-btn.active {
            background: #6366f1;
            color: white;
        }
        .zoom-percentage {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            min-width: 70px;
            text-align: center;
        }
        .zoom-percentage:hover {
            background: #e5e7eb;
        }
        .zoom-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }
        .zoom-container.grabbing {
            cursor: grabbing;
        }
        .zoom-viewport {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
        }
        .zoom-content {
            display: inline-block;
        }
        .minimap {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 2002;
            cursor: pointer;
        }
        .zoom-modal.light-mode .minimap {
            background: white;
            border: 2px solid #e5e7eb;
        }
        .minimap-title {
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .minimap-container {
            position: relative;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            overflow: hidden;
        }
        .minimap-content {
            width: 100%;
            height: auto;
            display: block;
        }
        .minimap-viewport {
            position: absolute;
            border: 2px solid #6366f1;
            background: rgba(99, 102, 241, 0.1);
            pointer-events: none;
        }
        .keyboard-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 2002;
            font-size: 11px;
            max-width: 300px;
        }
        .zoom-modal.light-mode .keyboard-help {
            background: white;
            border: 2px solid #e5e7eb;
        }
        .keyboard-help-title {
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .keyboard-shortcut {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: #4b5563;
        }
        .keyboard-key {
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
            font-size: 11px;
        }
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            z-index: 3000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            justify-content: center;
        }
        .toast.error {
            background: rgba(239, 68, 68, 0.95);
        }
        .toast.warning {
            background: rgba(245, 158, 11, 0.95);
        }
        .toast.info {
            background: rgba(59, 130, 246, 0.95);
        }
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Mermaid Studio Pro</h1>
            <p>Advanced diagram management with API documentation and workflow mapping</p>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">
                <button class="btn btn-primary" onclick="openModal()">‚ûï Add Diagram</button>
                <span class="diagram-count">Total: <strong id="diagramCount">0</strong></span>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-success" onclick="exportDiagrams()">üì§ Export JSON</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import JSON</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importDiagrams(event)">
                <button class="btn btn-success" onclick="downloadAllZip()">üì¶ Download All</button>
                <button class="btn btn-danger" onclick="clearAllDiagrams()">üóëÔ∏è Clear All</button>
            </div>
        </div>
        
        <div class="search-filter-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search diagrams by title or description..." onkeyup="filterDiagrams()">
            </div>
            <div class="filter-group">
                <span class="filter-label">Type:</span>
                <select id="typeFilter" onchange="filterDiagrams()">
                    <option value="all">All Types</option>
                    <option value="workflow">Workflow</option>
                    <option value="endpoint">Endpoint/API</option>
                    <option value="architecture">Architecture</option>
                    <option value="sequence">Sequence</option>
                    <option value="state">State Machine</option>
                    <option value="other">Other</option>
                </select>
            </div>
        </div>
        
        <div class="content">
            <div class="diagrams-carousel" id="diagramsCarousel">
                <div class="empty-state">
                    <div style="font-size: 72px; margin-bottom: 20px;">üìä</div>
                    <h3>No diagrams yet</h3>
                    <p>Create your first diagram to get started</p>
                    <button class="btn btn-primary" onclick="openModal()" style="margin-top: 20px; padding: 14px 28px; font-size: 16px;">+ Create First Diagram</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div class="modal" id="diagramModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Diagram</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="diagramForm" onsubmit="saveDiagram(event)">
                <div class="modal-body">
                    <div class="info-card">
                        <div class="info-card-title">üí° Pro Tip</div>
                        <div class="info-card-content">
                            Use diagram types to organize your documentation. Endpoint/API diagrams include special fields for request/response payloads, while Workflow diagrams help document business processes.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Diagram Type <span class="required">*</span></label>
                        <select id="diagramType" required onchange="toggleTypeSpecificFields()">
                            <option value="">Select a type...</option>
                            <option value="workflow">üìÑ Workflow - Business process flows</option>
                            <option value="endpoint">üîå Endpoint/API - API documentation with payloads</option>
                            <option value="architecture">üèóÔ∏è Architecture - System design diagrams</option>
                            <option value="sequence">üìù Sequence - Interaction diagrams</option>
                            <option value="state">üîÄ State Machine - State transitions</option>
                            <option value="other">üìÑ Other - General purpose</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Title <span class="required">*</span></label>
                        <input type="text" id="diagramTitle" required placeholder="e.g., User Authentication Flow">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="diagramDescription" placeholder="Describe the purpose of this diagram..." rows="3"></textarea>
                    </div>
                    
                    <div id="endpointFields" style="display: none;">
                        <div class="form-section">
                            <div class="form-section-title">üîå API Endpoint Details</div>
                            
                            <div class="form-group">
                                <label>HTTP Method</label>
                                <select id="httpMethod">
                                    <option value="">Select method...</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="PATCH">PATCH</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Endpoint Path</label>
                                <input type="text" id="endpointPath" placeholder="/api/v1/users/{id}">
                            </div>
                            
                            <div class="payload-section">
                                <div class="payload-header">
                                    <span class="payload-label">üì• Request Payloads</span>
                                    <button type="button" class="add-payload-btn" onclick="addRequestPayload()">+ Add Request</button>
                                </div>
                                <div id="requestPayloads"></div>
                            </div>
                            
                            <div class="payload-section">
                                <div class="payload-header">
                                    <span class="payload-label">üì§ Response Payloads</span>
                                    <button type="button" class="add-payload-btn" onclick="addResponsePayload()">+ Add Response</button>
                                </div>
                                <div id="responsePayloads"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="workflowFields" style="display: none;">
                        <div class="form-section">
                            <div class="form-section-title">üìÑ Workflow Details</div>
                            
                            <div class="form-group">
                                <label>Actors/Participants</label>
                                <input type="text" id="workflowActors" placeholder="e.g., User, System, Admin (comma-separated)">
                            </div>
                            
                            <div class="form-group">
                                <label>Trigger Event</label>
                                <input type="text" id="workflowTrigger" placeholder="What initiates this workflow?">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mermaid Code <span class="required">*</span></label>
                        <textarea id="diagramCode" required placeholder="graph TD&#10;    A[Start] --> B[End]"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="diagramTags" placeholder="authentication, security, critical">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Diagram</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Zoom Modal -->
    <div class="zoom-modal" id="zoomModal">
        <button class="zoom-close-btn" onclick="closeZoomModal()" title="Close (Esc)">‚úï</button>
        
        <div class="zoom-info-panel">
            <div class="zoom-info-title" id="zoomInfoTitle">Diagram Title</div>
            <div class="zoom-info-meta" id="zoomInfoMeta">Description</div>
        </div>
        
        <div class="zoom-controls">
            <div class="zoom-controls-row">
                <div class="zoom-percentage" id="zoomPercentage" title="Click to reset to 100%">100%</div>
            </div>
            <div class="zoom-controls-row">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In (+)">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out (-)">‚àí</button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom (0)">‚ü≤</button>
            </div>
            <div class="zoom-controls-row">
                <button class="zoom-btn" onclick="fitToScreen()" title="Fit to Screen (F)">‚ä°</button>
                <button class="zoom-btn" id="themeToggle" onclick="toggleTheme()" title="Toggle Theme (T)">‚òÄ</button>
                <button class="zoom-btn" onclick="toggleFullscreen()" title="Clean View Mode (Hide Controls)">‚õ∂</button>
            </div>
            <div class="zoom-controls-row">
                <button class="zoom-btn" onclick="exportFromZoom('svg')" title="Export SVG">SVG</button>
                <button class="zoom-btn" onclick="exportFromZoom('png')" title="Export PNG">PNG</button>
                <button class="zoom-btn" onclick="copyToClipboard()" title="Copy to Clipboard (C)">üìã</button>
            </div>
        </div>
        
        <div class="zoom-container" id="zoomContainer">
            <div class="zoom-viewport" id="zoomViewport">
                <div class="zoom-content" id="zoomContent"></div>
            </div>
        </div>
        
        <div class="minimap">
            <div class="minimap-title">Navigator</div>
            <div class="minimap-container" id="minimapContainer">
                <svg class="minimap-content" id="minimapContent"></svg>
                <div class="minimap-viewport" id="minimapViewport"></div>
            </div>
        </div>
        
        <div class="keyboard-help">
            <div class="keyboard-help-title">‚å®Ô∏è Keyboard Shortcuts</div>
            <div class="keyboard-shortcut">
                <span>Pan</span>
                <span class="keyboard-key">Arrow Keys</span>
            </div>
            <div class="keyboard-shortcut">
                <span>Zoom In/Out</span>
                <span class="keyboard-key">+/‚àí</span>
            </div>
            <div class="keyboard-shortcut">
                <span>Reset Zoom</span>
                <span class="keyboard-key">0</span>
            </div>
            <div class="keyboard-shortcut">
                <span>Fit to Screen</span>
                <span class="keyboard-key">F</span>
            </div>
            <div class="keyboard-shortcut">
                <span>Copy</span>
                <span class="keyboard-key">C</span>
            </div>
            <div class="keyboard-shortcut">
                <span>Close</span>
                <span class="keyboard-key">Esc</span>
            </div>
        </div>
    </div>

    <script>
        let diagrams = [];
        let editingIndex = -1;
        let currentZoomLevel = 1;
        let currentDiagramIndex = -1;
        let requestPayloadCounter = 0;
        let responsePayloadCounter = 0;
        
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let isLightMode = false;
        let isCleanMode = false;
        
        function loadDiagrams() {
            const saved = localStorage.getItem('mermaid-diagrams-pro');
            if (saved) {
                try {
                    diagrams = JSON.parse(saved);
                    renderDiagrams();
                    if (diagrams.length > 0) {
                        showToast(`üìä Loaded ${diagrams.length} diagram(s) from storage`, 'info');
                    }
                } catch (e) {
                    console.error('Failed to load diagrams:', e);
                    showToast('Failed to load saved diagrams', 'error');
                }
            }
        }
        
        function saveDiagramsToStorage() {
            localStorage.setItem('mermaid-diagrams-pro', JSON.stringify(diagrams));
        }
        
        function generateFilename(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }
        
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        function toggleTypeSpecificFields() {
            const type = document.getElementById('diagramType').value;
            document.getElementById('endpointFields').style.display = type === 'endpoint' ? 'block' : 'none';
            document.getElementById('workflowFields').style.display = type === 'workflow' ? 'block' : 'none';
        }

        function addRequestPayload() {
            const container = document.getElementById('requestPayloads');
            const id = ++requestPayloadCounter;
            const item = document.createElement('div');
            item.className = 'payload-item';
            item.id = `req-${id}`;
            item.innerHTML = `
                <div class="payload-item-header">
                    <span style="font-weight: 600; font-size: 13px;">Request ${id}</span>
                    <button type="button" class="remove-payload-btn" onclick="removePayload('req-${id}')">Remove</button>
                </div>
                <div class="payload-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Status Code</label>
                        <input type="text" name="req-status-${id}" placeholder="e.g., 200">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Content Type</label>
                        <input type="text" name="req-contentType-${id}" placeholder="application/json">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                    <label style="font-size: 12px;">JSON Payload</label>
                    <textarea name="req-json-${id}" rows="4" placeholder='{\n  "key": "value"\n}' style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
            `;
            container.appendChild(item);
        }

        function addResponsePayload() {
            const container = document.getElementById('responsePayloads');
            const id = ++responsePayloadCounter;
            const item = document.createElement('div');
            item.className = 'payload-item';
            item.id = `res-${id}`;
            item.innerHTML = `
                <div class="payload-item-header">
                    <span style="font-weight: 600; font-size: 13px;">Response ${id}</span>
                    <button type="button" class="remove-payload-btn" onclick="removePayload('res-${id}')">Remove</button>
                </div>
                <div class="payload-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Status Code</label>
                        <input type="text" name="res-status-${id}" placeholder="e.g., 200, 400">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Content Type</label>
                        <input type="text" name="res-contentType-${id}" placeholder="application/json">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                    <label style="font-size: 12px;">JSON Payload</label>
                    <textarea name="res-json-${id}" rows="4" placeholder='{\n  "key": "value"\n}' style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
            `;
            container.appendChild(item);
        }

        function removePayload(id) {
            document.getElementById(id).remove();
        }

        function openModal(index = -1) {
            editingIndex = index;
            const modal = document.getElementById('diagramModal');
            const modalTitle = document.getElementById('modalTitle');
            
            requestPayloadCounter = 0;
            responsePayloadCounter = 0;
            document.getElementById('requestPayloads').innerHTML = '';
            document.getElementById('responsePayloads').innerHTML = '';
            
            if (index >= 0) {
                const diagram = diagrams[index];
                modalTitle.textContent = 'Edit Diagram';
                document.getElementById('diagramType').value = diagram.type || 'other';
                document.getElementById('diagramTitle').value = diagram.title;
                document.getElementById('diagramDescription').value = diagram.description || '';
                document.getElementById('diagramCode').value = diagram.code;
                document.getElementById('diagramTags').value = diagram.tags || '';
                
                if (diagram.type === 'endpoint') {
                    document.getElementById('httpMethod').value = diagram.httpMethod || '';
                    document.getElementById('endpointPath').value = diagram.endpointPath || '';
                    
                    if (diagram.requestPayloads) {
                        diagram.requestPayloads.forEach(payload => {
                            addRequestPayload();
                            const id = requestPayloadCounter;
                            document.querySelector(`[name="req-status-${id}"]`).value = payload.status || '';
                            document.querySelector(`[name="req-contentType-${id}"]`).value = payload.contentType || '';
                            document.querySelector(`[name="req-json-${id}"]`).value = payload.json || '';
                        });
                    }
                    
                    if (diagram.responsePayloads) {
                        diagram.responsePayloads.forEach(payload => {
                            addResponsePayload();
                            const id = responsePayloadCounter;
                            document.querySelector(`[name="res-status-${id}"]`).value = payload.status || '';
                            document.querySelector(`[name="res-contentType-${id}"]`).value = payload.contentType || '';
                            document.querySelector(`[name="res-json-${id}"]`).value = payload.json || '';
                        });
                    }
                } else if (diagram.type === 'workflow') {
                    document.getElementById('workflowActors').value = diagram.workflowActors || '';
                    document.getElementById('workflowTrigger').value = diagram.workflowTrigger || '';
                }
                
                toggleTypeSpecificFields();
            } else {
                modalTitle.textContent = 'Add New Diagram';
                document.getElementById('diagramForm').reset();
                toggleTypeSpecificFields();
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('diagramModal').classList.remove('active');
            editingIndex = -1;
        }

        function saveDiagram(event) {
            event.preventDefault();
            
            const type = document.getElementById('diagramType').value;
            const title = document.getElementById('diagramTitle').value.trim();
            const description = document.getElementById('diagramDescription').value.trim();
            const code = document.getElementById('diagramCode').value.trim();
            const tags = document.getElementById('diagramTags').value.trim();
            const name = generateFilename(title);
            
            const diagram = { 
                name, 
                title, 
                description, 
                code, 
                type,
                tags,
                createdAt: editingIndex >= 0 ? diagrams[editingIndex].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (type === 'endpoint') {
                diagram.httpMethod = document.getElementById('httpMethod').value;
                diagram.endpointPath = document.getElementById('endpointPath').value;
                
                diagram.requestPayloads = [];
                for (let i = 1; i <= requestPayloadCounter; i++) {
                    const statusEl = document.querySelector(`[name="req-status-${i}"]`);
                    if (statusEl && document.getElementById(`req-${i}`)) {
                        diagram.requestPayloads.push({
                            status: statusEl.value,
                            contentType: document.querySelector(`[name="req-contentType-${i}"]`).value,
                            json: document.querySelector(`[name="req-json-${i}"]`).value
                        });
                    }
                }
                
                diagram.responsePayloads = [];
                for (let i = 1; i <= responsePayloadCounter; i++) {
                    const statusEl = document.querySelector(`[name="res-status-${i}"]`);
                    if (statusEl && document.getElementById(`res-${i}`)) {
                        diagram.responsePayloads.push({
                            status: statusEl.value,
                            contentType: document.querySelector(`[name="res-contentType-${i}"]`).value,
                            json: document.querySelector(`[name="res-json-${i}"]`).value
                        });
                    }
                }
            }
            
            if (type === 'workflow') {
                diagram.workflowActors = document.getElementById('workflowActors').value;
                diagram.workflowTrigger = document.getElementById('workflowTrigger').value;
            }
            
            const isEdit = editingIndex >= 0;
            
            if (isEdit) {
                diagrams[editingIndex] = diagram;
            } else {
                if (diagrams.some(d => d.name === name)) {
                    showToast('A diagram with this title already exists!', 'error');
                    return;
                }
                diagrams.push(diagram);
            }
            
            saveDiagramsToStorage();
            renderDiagrams();
            closeModal();
            
            // Show success toast
            showToast(isEdit ? `‚úèÔ∏è "${title}" updated successfully!` : `‚ûï "${title}" created successfully!`, 'success');
        }

        async function renderDiagrams() {
            const carousel = document.getElementById('diagramsCarousel');
            const count = document.getElementById('diagramCount');
            
            count.textContent = diagrams.length;
            
            if (diagrams.length === 0) {
                carousel.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 72px; margin-bottom: 20px;">üìä</div>
                        <h3>No diagrams yet</h3>
                        <p>Create your first diagram to get started</p>
                        <button class="btn btn-primary" onclick="openModal()" style="margin-top: 20px; padding: 14px 28px; font-size: 16px;">+ Create First Diagram</button>
                    </div>
                `;
                return;
            }
            
            carousel.innerHTML = '';
            
            for (let i = 0; i < diagrams.length; i++) {
                const diagram = diagrams[i];
                const typeClass = `type-${diagram.type || 'other'}`;
                const typeLabels = {
                    workflow: 'üìÑ Workflow',
                    endpoint: 'üîå Endpoint/API',
                    architecture: 'üèóÔ∏è Architecture',
                    sequence: 'üìù Sequence',
                    state: 'üîÄ State',
                    other: 'üìÑ Other'
                };
                
                let metaInfo = `Updated: ${new Date(diagram.updatedAt || Date.now()).toLocaleDateString()}`;
                if (diagram.type === 'endpoint' && diagram.httpMethod && diagram.endpointPath) {
                    metaInfo = `${diagram.httpMethod} ${diagram.endpointPath}`;
                }
                
                const card = document.createElement('div');
                card.className = 'diagram-card';
                card.innerHTML = `
                    <div class="diagram-card-header">
                        <div class="diagram-card-title">
                            <span class="type-badge ${typeClass}">${typeLabels[diagram.type] || 'üìÑ Other'}</span>
                            ${diagram.title}
                        </div>
                        <div class="diagram-card-meta">${metaInfo}</div>
                        <div class="diagram-card-actions">
                            <button class="btn-edit" onclick="openModal(${i})" title="Edit Diagram">‚úèÔ∏è</button>
                            <button class="btn-info" onclick="showDetails(${i})" title="View Details">‚ÑπÔ∏è</button>
                            <button class="btn-delete" onclick="deleteDiagram(${i})" title="Delete Diagram">üóëÔ∏è</button>
                            <div style="position: relative;">
                                <button class="btn-export" onclick="toggleExportMenu(${i}, event)" title="Export Diagram">‚¨áÔ∏è</button>
                                <div class="export-dropdown" id="export-menu-${i}">
                                    <button onclick="event.stopPropagation(); exportDiagramAs(${i}, 'svg')">üìÑ Export as SVG</button>
                                    <button onclick="event.stopPropagation(); exportDiagramAs(${i}, 'png')">üñºÔ∏è Export as PNG</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="diagram-preview" id="preview-${i}" onclick="openZoomModal(${i})" title="Click to zoom">
                        <div style="color: #666; font-style: italic;">Rendering...</div>
                    </div>
                `;
                carousel.appendChild(card);
                
                try {
                    // FIX: Use unique ID with timestamp and random string to avoid cache conflicts
                    const uniqueId = `diagram-${i}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    const { svg } = await mermaid.render(uniqueId, diagram.code);
                    const preview = document.getElementById(`preview-${i}`);
                    preview.innerHTML = svg;
                } catch (error) {
                    console.error(`Error rendering ${diagram.name}:`, error);
                    const preview = document.getElementById(`preview-${i}`);
                    preview.innerHTML = '<div style="color: red;">Error rendering diagram</div>';
                    showToast(`‚ö†Ô∏è Failed to render "${diagram.title}"`, 'error');
                }
            }
            
            filterDiagrams();
        }

        function filterDiagrams() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            
            const cards = document.querySelectorAll('.diagram-card');
            let visibleCount = 0;
            
            cards.forEach((card, index) => {
                const diagram = diagrams[index];
                const matchesSearch = diagram.title.toLowerCase().includes(searchTerm) || 
                                     (diagram.description || '').toLowerCase().includes(searchTerm) ||
                                     (diagram.tags || '').toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === 'all' || diagram.type === typeFilter;
                
                if (matchesSearch && matchesType) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            const carousel = document.getElementById('diagramsCarousel');
            if (visibleCount === 0 && diagrams.length > 0) {
                if (!document.getElementById('no-results')) {
                    const noResults = document.createElement('div');
                    noResults.id = 'no-results';
                    noResults.className = 'empty-state';
                    noResults.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
                        <h3>No diagrams found</h3>
                        <p>Try adjusting your search or filters</p>
                    `;
                    carousel.appendChild(noResults);
                }
            } else {
                const noResults = document.getElementById('no-results');
                if (noResults) noResults.remove();
            }
        }

        function showDetails(index) {
            const diagram = diagrams[index];
            const content = document.createElement('div');
            content.style.padding = '20px';
            
            let html = `
                <h3 style="color: #6366f1; margin-bottom: 20px;">${diagram.title}</h3>
                <p style="margin-bottom: 15px;"><strong>Type:</strong> ${diagram.type || 'other'}</p>
                <p style="margin-bottom: 15px;"><strong>Description:</strong> ${diagram.description || 'No description'}</p>
                <p style="margin-bottom: 15px;"><strong>Tags:</strong> ${diagram.tags || 'None'}</p>
            `;
            
            if (diagram.type === 'endpoint') {
                html += `
                    <h4 style="color: #6366f1; margin: 20px 0 10px;">Endpoint Details</h4>
                    <p style="margin-bottom: 10px;"><strong>Method:</strong> ${diagram.httpMethod || 'N/A'}</p>
                    <p style="margin-bottom: 15px;"><strong>Path:</strong> ${diagram.endpointPath || 'N/A'}</p>
                `;
                
                if (diagram.requestPayloads && diagram.requestPayloads.length > 0) {
                    html += `<h4 style="color: #6366f1; margin: 20px 0 10px;">Request Payloads</h4>`;
                    diagram.requestPayloads.forEach((payload, i) => {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <p><strong>Status:</strong> ${payload.status}</p>
                                <p><strong>Content-Type:</strong> ${payload.contentType}</p>
                                <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px;">${payload.json}</pre>
                            </div>
                        `;
                    });
                }
                
                if (diagram.responsePayloads && diagram.responsePayloads.length > 0) {
                    html += `<h4 style="color: #6366f1; margin: 20px 0 10px;">Response Payloads</h4>`;
                    diagram.responsePayloads.forEach((payload, i) => {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <p><strong>Status:</strong> ${payload.status}</p>
                                <p><strong>Content-Type:</strong> ${payload.contentType}</p>
                                <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px;">${payload.json}</pre>
                            </div>
                        `;
                    });
                }
            }
            
            if (diagram.type === 'workflow') {
                html += `
                    <h4 style="color: #6366f1; margin: 20px 0 10px;">Workflow Details</h4>
                    <p style="margin-bottom: 10px;"><strong>Actors:</strong> ${diagram.workflowActors || 'N/A'}</p>
                    <p style="margin-bottom: 15px;"><strong>Trigger:</strong> ${diagram.workflowTrigger || 'N/A'}</p>
                `;
            }
            
            content.innerHTML = html;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Diagram Details</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            modal.querySelector('.modal-body').appendChild(content);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function openZoomModal(index) {
            const diagram = diagrams[index];
            currentDiagramIndex = index;
            const modal = document.getElementById('zoomModal');
            const content = document.getElementById('zoomContent');
            const infoTitle = document.getElementById('zoomInfoTitle');
            const infoMeta = document.getElementById('zoomInfoMeta');
            
            const preview = document.getElementById(`preview-${index}`);
            if (!preview) return;
            
            const svg = preview.querySelector('svg');
            if (!svg) return;
            
            infoTitle.textContent = diagram.title;
            let metaText = diagram.description || 'No description';
            if (diagram.type === 'endpoint' && diagram.httpMethod && diagram.endpointPath) {
                metaText = `${diagram.httpMethod} ${diagram.endpointPath}\n${metaText}`;
            }
            infoMeta.textContent = metaText;
            
            content.innerHTML = svg.outerHTML;
            
            currentZoomLevel = 1;
            panX = 0;
            panY = 0;
            updateZoomTransform();
            updateZoomPercentage();
            
            setupMinimap(svg);
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => fitToScreen(), 100);
        }

        function closeZoomModal() {
            const modal = document.getElementById('zoomModal');
            modal.classList.remove('active');
            modal.classList.remove('fullscreen-clean');
            document.body.style.overflow = 'auto';
            currentDiagramIndex = -1;
            isCleanMode = false;
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        function updateZoomTransform() {
            const viewport = document.getElementById('zoomViewport');
            viewport.style.transform = `translate(-50%, -50%) translate(${panX}px, ${panY}px) scale(${currentZoomLevel})`;
            updateMinimap();
        }

        function updateZoomPercentage() {
            document.getElementById('zoomPercentage').textContent = Math.round(currentZoomLevel * 100) + '%';
        }

        function zoomIn() {
            currentZoomLevel = Math.min(currentZoomLevel + 0.2, 5);
            updateZoomTransform();
            updateZoomPercentage();
        }

        function zoomOut() {
            currentZoomLevel = Math.max(currentZoomLevel - 0.2, 0.1);
            updateZoomTransform();
            updateZoomPercentage();
        }

        function resetZoom() {
            currentZoomLevel = 1;
            panX = 0;
            panY = 0;
            updateZoomTransform();
            updateZoomPercentage();
        }

        function fitToScreen() {
            const container = document.getElementById('zoomContainer');
            const content = document.getElementById('zoomContent');
            const svg = content.querySelector('svg');
            
            if (!svg) return;
            
            const containerRect = container.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();
            
            const scaleX = (containerRect.width * 0.9) / svgRect.width;
            const scaleY = (containerRect.height * 0.9) / svgRect.height;
            
            currentZoomLevel = Math.min(scaleX, scaleY);
            panX = 0;
            panY = 0;
            updateZoomTransform();
            updateZoomPercentage();
        }

        function initializeZoomControls() {
            const container = document.getElementById('zoomContainer');
            const zoomPercentage = document.getElementById('zoomPercentage');
            const minimapContainer = document.getElementById('minimapContainer');
            
            if (!container || !zoomPercentage || !minimapContainer) return;
            
            container.addEventListener('wheel', (e) => {
                if (!document.getElementById('zoomModal').classList.contains('active')) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newZoom = Math.max(0.1, Math.min(5, currentZoomLevel + delta));
                
                const rect = container.getBoundingClientRect();
                const mouseX = e.clientX - rect.left - rect.width / 2;
                const mouseY = e.clientY - rect.top - rect.height / 2;
                
                const scale = newZoom / currentZoomLevel;
                panX = mouseX - scale * (mouseX - panX);
                panY = mouseY - scale * (mouseY - panY);
                
                currentZoomLevel = newZoom;
                updateZoomTransform();
                updateZoomPercentage();
            }, { passive: false });
            
            container.addEventListener('mousedown', (e) => {
                if (!document.getElementById('zoomModal').classList.contains('active')) return;
                
                isDragging = true;
                dragStartX = e.clientX - panX;
                dragStartY = e.clientY - panY;
                container.classList.add('grabbing');
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                panX = e.clientX - dragStartX;
                panY = e.clientY - dragStartY;
                updateZoomTransform();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                container.classList.remove('grabbing');
            });
            
            container.addEventListener('dblclick', () => {
                if (!document.getElementById('zoomModal').classList.contains('active')) return;
                resetZoom();
            });
            
            zoomPercentage.addEventListener('click', () => {
                currentZoomLevel = 1;
                updateZoomTransform();
                updateZoomPercentage();
            });
            
            minimapContainer.addEventListener('click', (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const content = document.getElementById('zoomContent');
                const svg = content?.querySelector('svg');
                const minimapSvg = document.getElementById('minimapContent')?.querySelector('svg');
                
                if (!svg || !minimapSvg) return;
                
                const minimapSvgRect = minimapSvg.getBoundingClientRect();
                const minimapScale = minimapSvgRect.width / (svg.viewBox?.baseVal?.width || svg.getBoundingClientRect().width / currentZoomLevel);
                
                const diagramX = (clickX - minimapSvgRect.width / 2) / minimapScale;
                const diagramY = (clickY - minimapSvgRect.height / 2) / minimapScale;
                
                panX = -diagramX * currentZoomLevel;
                panY = -diagramY * currentZoomLevel;
                
                updateZoomTransform();
            });
        }

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('zoomModal');
            if (!modal.classList.contains('active')) return;
            
            switch(e.key) {
                case 'Escape':
                    closeZoomModal();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                case '_':
                    e.preventDefault();
                    zoomOut();
                    break;
                case '0':
                    e.preventDefault();
                    resetZoom();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    fitToScreen();
                    break;
                case 't':
                case 'T':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'c':
                case 'C':
                    e.preventDefault();
                    copyToClipboard();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    panY += 50;
                    updateZoomTransform();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    panY -= 50;
                    updateZoomTransform();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    panX += 50;
                    updateZoomTransform();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    panX -= 50;
                    updateZoomTransform();
                    break;
            }
        });

        function setupMinimap(svg) {
            const minimapContent = document.getElementById('minimapContent');
            minimapContent.innerHTML = svg.outerHTML;
            updateMinimap();
        }

        function updateMinimap() {
            const viewport = document.getElementById('minimapViewport');
            const container = document.getElementById('zoomContainer');
            const content = document.getElementById('zoomContent');
            const svg = content?.querySelector('svg');
            const minimapContent = document.getElementById('minimapContent');
            
            if (!svg || !viewport || !minimapContent) return;
            
            const containerRect = container.getBoundingClientRect();
            const minimapContainer = document.getElementById('minimapContainer');
            const minimapRect = minimapContainer.getBoundingClientRect();
            
            const minimapSvg = minimapContent.querySelector('svg');
            if (!minimapSvg) return;
            
            const minimapSvgRect = minimapSvg.getBoundingClientRect();
            
            const visibleWidthInDiagram = containerRect.width / currentZoomLevel;
            const visibleHeightInDiagram = containerRect.height / currentZoomLevel;
            
            const minimapScale = minimapSvgRect.width / (svg.viewBox?.baseVal?.width || svg.getBoundingClientRect().width / currentZoomLevel);
            
            const viewportWidth = visibleWidthInDiagram * minimapScale;
            const viewportHeight = visibleHeightInDiagram * minimapScale;
            
            const minimapCenterX = minimapSvgRect.width / 2;
            const minimapCenterY = minimapSvgRect.height / 2;
            
            const panXInDiagram = -panX / currentZoomLevel;
            const panYInDiagram = -panY / currentZoomLevel;
            
            const viewportX = minimapCenterX + (panXInDiagram * minimapScale) - (viewportWidth / 2);
            const viewportY = minimapCenterY + (panYInDiagram * minimapScale) - (viewportHeight / 2);
            
            viewport.style.left = viewportX + 'px';
            viewport.style.top = viewportY + 'px';
            viewport.style.width = viewportWidth + 'px';
            viewport.style.height = viewportHeight + 'px';
        }

        function toggleTheme() {
            isLightMode = !isLightMode;
            const modal = document.getElementById('zoomModal');
            const btn = document.getElementById('themeToggle');
            
            if (isLightMode) {
                modal.classList.add('light-mode');
                btn.textContent = 'üåô';
            } else {
                modal.classList.remove('light-mode');
                btn.textContent = '‚òÄ';
            }
        }

        function toggleFullscreen() {
            isCleanMode = !isCleanMode;
            const modal = document.getElementById('zoomModal');
            
            if (isCleanMode) {
                modal.classList.add('fullscreen-clean');
                if (!document.fullscreenElement) {
                    modal.requestFullscreen();
                }
            } else {
                modal.classList.remove('fullscreen-clean');
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }
        }

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                isCleanMode = false;
                document.getElementById('zoomModal').classList.remove('fullscreen-clean');
            }
        });

        async function exportFromZoom(format) {
            if (currentDiagramIndex === -1) return;
            
            const diagram = diagrams[currentDiagramIndex];
            const content = document.getElementById('zoomContent');
            const svg = content.querySelector('svg');
            
            if (!svg) return;
            
            if (format === 'svg') {
                const svgString = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${diagram.name}.svg`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('üìÑ SVG exported successfully!', 'success');
            } else if (format === 'png') {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const svgRect = svg.getBoundingClientRect();
                const scale = 2;
                canvas.width = svgRect.width * scale;
                canvas.height = svgRect.height * scale;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const svgString = new XMLSerializer().serializeToString(svg);
                const img = new Image();
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    
                    canvas.toBlob(function(blob) {
                        const pngUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = `${diagram.name}.png`;
                        a.click();
                        URL.revokeObjectURL(pngUrl);
                        showToast('üñºÔ∏è PNG exported successfully!', 'success');
                    });
                };
                
                img.src = url;
            }
        }

        async function copyToClipboard() {
            if (currentDiagramIndex === -1) return;
            
            const content = document.getElementById('zoomContent');
            const svg = content.querySelector('svg');
            
            if (!svg) return;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const svgRect = svg.getBoundingClientRect();
                const scale = 2;
                canvas.width = svgRect.width * scale;
                canvas.height = svgRect.height * scale;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const svgString = new XMLSerializer().serializeToString(svg);
                const img = new Image();
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = async function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    
                    canvas.toBlob(async function(blob) {
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            showToast('üìã Copied to clipboard!', 'success');
                        } catch (err) {
                            console.error('Failed to copy:', err);
                            showToast('Failed to copy to clipboard', 'error');
                        }
                    });
                };
                
                img.src = url;
            } catch (err) {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard', 'error');
            }
        }

        function showToast(message, type = 'success') {
            // Remove any existing toasts first
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span style="font-size: 18px;">${icons[type] || icons.success}</span> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleExportMenu(index, event) {
            event.stopPropagation();
            const menu = document.getElementById(`export-menu-${index}`);
            
            document.querySelectorAll('.export-dropdown').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            
            menu.classList.toggle('active');
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.export-dropdown').forEach(m => {
                m.classList.remove('active');
            });
        });

        async function exportDiagramAs(index, format) {
            const diagram = diagrams[index];
            const preview = document.getElementById(`preview-${index}`);
            const svg = preview?.querySelector('svg');
            
            if (!svg) return;
            
            if (format === 'svg') {
                const svgString = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${diagram.name}.svg`;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`üìÑ "${diagram.title}" exported as SVG!`, 'success');
            } else if (format === 'png') {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const svgRect = svg.getBoundingClientRect();
                const scale = 2;
                canvas.width = svgRect.width * scale;
                canvas.height = svgRect.height * scale;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const svgString = new XMLSerializer().serializeToString(svg);
                const img = new Image();
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    
                    canvas.toBlob(function(blob) {
                        const pngUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = `${diagram.name}.png`;
                        a.click();
                        URL.revokeObjectURL(pngUrl);
                        showToast(`üñºÔ∏è "${diagram.title}" exported as PNG!`, 'success');
                    });
                };
                
                img.src = url;
            }
        }

        function deleteDiagram(index) {
            const diagram = diagrams[index];
            if (confirm(`Are you sure you want to delete "${diagram.title}"?`)) {
                diagrams.splice(index, 1);
                saveDiagramsToStorage();
                renderDiagrams();
                showToast(`üóëÔ∏è "${diagram.title}" deleted successfully!`, 'success');
            }
        }

        function exportDiagrams() {
            if (diagrams.length === 0) {
                showToast('No diagrams to export!', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(diagrams, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mermaid-diagrams-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üì§ Exported ${diagrams.length} diagram(s) to JSON!`, 'success');
        }
        
        function importDiagrams(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) {
                        showToast('Invalid JSON file format!', 'error');
                        return;
                    }
                    
                    const conflicts = imported.filter(imp => 
                        diagrams.some(d => d.name === imp.name)
                    );
                    
                    if (conflicts.length > 0) {
                        const proceed = confirm(
                            `${conflicts.length} diagram(s) with the same name already exist. Replace them?`
                        );
                        if (!proceed) {
                            showToast('Import cancelled', 'info');
                            return;
                        }
                    }
                    
                    imported.forEach(imp => {
                        const existingIndex = diagrams.findIndex(d => d.name === imp.name);
                        if (existingIndex >= 0) {
                            diagrams[existingIndex] = imp;
                        } else {
                            diagrams.push(imp);
                        }
                    });
                    
                    saveDiagramsToStorage();
                    renderDiagrams();
                    showToast(`üì• Successfully imported ${imported.length} diagram(s)!`, 'success');
                } catch (error) {
                    showToast('Failed to import JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        async function downloadAllZip() {
            if (diagrams.length === 0) {
                showToast('No diagrams to download!', 'warning');
                return;
            }
            
            showToast('üì¶ Preparing ZIP file...', 'info');
            
            const zip = new JSZip();
            
            for (let i = 0; i < diagrams.length; i++) {
                const diagram = diagrams[i];
                const preview = document.getElementById(`preview-${i}`);
                const svgElement = preview?.querySelector('svg');
                
                if (svgElement) {
                    const svgString = new XMLSerializer().serializeToString(svgElement);
                    zip.file(`${diagram.name}.svg`, svgString);
                }
            }
            
            zip.file('diagrams-metadata.json', JSON.stringify(diagrams, null, 2));
            
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mermaid-diagrams-pro.zip';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üì¶ Downloaded ${diagrams.length} diagram(s) as ZIP!`, 'success');
        }
        
        function clearAllDiagrams() {
            if (diagrams.length === 0) {
                showToast('No diagrams to clear!', 'warning');
                return;
            }
            
            if (confirm(`Delete all ${diagrams.length} diagram(s)? This cannot be undone!`)) {
                const count = diagrams.length;
                diagrams = [];
                saveDiagramsToStorage();
                renderDiagrams();
                showToast(`üóëÔ∏è Cleared ${count} diagram(s) successfully!`, 'success');
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            loadDiagrams();
            initializeZoomControls();
        });
        
        window.addEventListener('keydown', function(event) {
            const diagramModal = document.getElementById('diagramModal');
            if (event.key === 'Escape' && diagramModal.classList.contains('active')) {
                closeModal();
            }
        });
    </script>
</body>
</html>